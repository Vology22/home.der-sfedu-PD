@{
    ViewData["Title"] = "Профиль пользователя";
    
    // Получаем данные пользователя
    var currentUser = ViewBag.CurrentUser as HomederProfile.Models.User;
    var properties = ViewBag.Properties as List<HomederProfile.Models.Property> ?? new List<HomederProfile.Models.Property>();
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    
    <!-- Подключаем Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .property-card { transition: transform 0.3s; }
        .property-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">🏠 Home.Der</a>
            @if (currentUser != null)
            {
                <div class="navbar-text text-white">
                    👤 <strong>@currentUser.FullName</strong>
                    <a href="@Url.Action("Logout", "Home")" class="btn btn-sm btn-outline-light ms-3">Выйти</a>
                </div>
            }
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Блок для входа -->
        <div id="loginSection" class="@(currentUser == null ? "" : "hidden")">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-body text-center p-5">
                            <h2 class="mb-4">🔑 Вход в профиль</h2>
                            <p class="text-muted mb-4">
                                Введите ваш <strong>user_id</strong> для доступа к профилю
                            </p>
                            
                            <div class="mb-4">
                                <input type="number" 
                                       id="userIdInput" 
                                       class="form-control form-control-lg text-center" 
                                       placeholder="Например: 12345"
                                       min="1">
                                <small class="form-text text-muted">
                                    Цифры из вашего ID в Telegram
                                </small>
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary btn-lg w-100 mb-3">
                                Войти в профиль
                            </button>
                            
                            <div class="alert alert-info mt-3">
                                <small>
                                    <strong>ℹ️ Или используйте ссылку:</strong><br>
                                    https://ваш-сайт.ru/#id-user=<span id="exampleId">12345</span>
                                </small>
                            </div>
                            
                            <div id="loginError" class="alert alert-danger mt-3 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Блок профиля -->
        <div id="profileSection" class="@(currentUser == null ? "hidden" : "")">
            <!-- Информация о пользователе -->
            <div class="card mb-4 shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                 style="width: 100px; height: 100px; font-size: 36px; margin: 0 auto;">
                                @if (!string.IsNullOrEmpty(currentUser?.FullName))
                                {
                                    @currentUser.FullName[0]
                                }
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h1 class="h2 mb-2">@currentUser?.FullName</h1>
                            <p class="text-muted mb-2">
                                <strong>ID:</strong> @currentUser?.UserId | 
                                <strong>Telegram:</strong> @currentUser?.TgId
                            </p>
                            <p class="lead mb-3">@currentUser?.Bio</p>
                            <p class="text-muted">
                                <small>📅 Зарегистрирован: @currentUser?.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                            </p>
                        </div>
                        <div class="col-md-2 text-end">
                            <a href="@Url.Action("Logout", "Home")" class="btn btn-outline-danger">🚪 Выйти</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Объявления пользователя -->
            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="h3 mb-3">🏠 Мои объявления</h2>
                    
                    @if (properties.Any())
                    {
                        <div class="row">
                            @foreach (var property in properties)
                            {
                                var coverImage = property.Images.FirstOrDefault(i => i.IsCover)?.ImgUrl;
                                
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100 shadow property-card">
                                        @if (!string.IsNullOrEmpty(coverImage))
                                        {
                                            <img src="@coverImage" 
                                                 class="card-img-top" 
                                                 alt="@property.Title" 
                                                 style="height: 200px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" 
                                                 style="height: 200px;">
                                                <span class="text-white">📷 Нет фото</span>
                                            </div>
                                        }
                                        
                                        <div class="card-body">
                                            <h5 class="card-title">@property.Title</h5>
                                            <p class="card-text text-success fw-bold h5">
                                                @(property.Price?.ToString("N0") ?? "💰 Цена не указана") ₽
                                            </p>
                                            <p class="card-text">
                                                📍 @property.City
                                            </p>
                                            <p class="card-text text-muted small">
                                                @property.Description?.Substring(0, Math.Min(100, property.Description.Length))...
                                            </p>
                                        </div>
                                        <div class="card-footer bg-white">
                                            <small class="text-muted">
                                                📅 @property.CreatedAt.ToString("dd.MM.yyyy")
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            У вас пока нет объявлений
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript для работы с хэшем -->
    <script>
        // Функция для получения user_id из хэша URL (#id-user=12345)
        function getUserIdFromHash() {
            // Получаем часть URL после #
            const hash = window.location.hash.substring(1);
            
            // Преобразуем параметры из хэша
            const params = new URLSearchParams(hash);
            
            // Возвращаем значение параметра id-user
            return params.get('id-user');
        }

        // Функция входа пользователя
        async function login() {
            let userId = document.getElementById('userIdInput').value;
            
            // Если поле пустое, проверяем хэш
            if (!userId) {
                userId = getUserIdFromHash();
            }
            
            // Проверяем, что ввели корректный ID
            if (!userId || isNaN(userId) || userId <= 0) {
                showError('❌ Пожалуйста, введите корректный user_id');
                return;
            }
            
            // Скрываем предыдущие ошибки
            document.getElementById('loginError').classList.add('hidden');
            
            try {
                // Отправляем запрос на сервер
                const response = await fetch('/Home/SetUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ UserId: userId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Успешный вход - перезагружаем страницу с параметром
                    window.location.href = '/Home/Index?userId=' + userId;
                } else {
                    // Показываем ошибку
                    showError('❌ ' + (data.error || 'Произошла ошибка'));
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showError('❌ Не удалось подключиться к серверу');
            }
        }

        // Функция показа ошибки
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // При загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем user_id из хэша
            const userId = getUserIdFromHash();
            
            if (userId) {
                // Показываем пример в ссылке
                document.getElementById('exampleId').textContent = userId;
                
                // Заполняем поле ввода
                document.getElementById('userIdInput').value = userId;
                
                // Автоматически пытаемся войти
                login();
            }
        });

        // Слушаем изменения в хэше (если пользователь ввел новую ссылку)
        window.addEventListener('hashchange', function() {
            const userId = getUserIdFromHash();
            if (userId) {
                document.getElementById('userIdInput').value = userId;
                login();
            }
        });
    </script>
    
    <!-- Подключаем иконки Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</body>
</html>